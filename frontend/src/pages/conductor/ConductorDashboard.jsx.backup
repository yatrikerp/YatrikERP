import React, { useState, useEffect, useCallback } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../../context/AuthContext';
import './conductor.modern.css';
import { 
  MapPin, 
  CheckCircle, 
  Play, 
  LogOut,
  Activity,
  RefreshCw,
  Fuel,
  AlertTriangle,
  Bus,
  Bell,
  Wrench,
  AlertCircle
} from 'lucide-react';

const ConductorDashboard = () => {
  const navigate = useNavigate();
  const { user, logout } = useAuth();
  
  // State management
  const [refreshInterval, setRefreshInterval] = useState(null);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [dutyStatus, setDutyStatus] = useState('assigned'); // not_assigned, assigned, active, completed
  const [currentTime, setCurrentTime] = useState(new Date());
  const [notifications] = useState(3);

  // Refresh dashboard data
  const refreshDashboard = useCallback(async () => {
    setIsRefreshing(true);
    try {
      // Simulate API call
      await new Promise(resolve => setTimeout(resolve, 1000));
    } catch (error) {
      console.error('Error refreshing dashboard:', error);
    } finally {
      setIsRefreshing(false);
    }
  }, []);

  // Handle logout
  const handleLogout = useCallback(() => {
    logout();
    navigate('/login');
  }, [logout, navigate]);

  // Initialize dashboard
  useEffect(() => {
    refreshDashboard();
    
    // Set up auto-refresh every 30 seconds
    const interval = setInterval(refreshDashboard, 30000);
    setRefreshInterval(interval);
    
    // Update time every second
    const timeInterval = setInterval(() => {
      setCurrentTime(new Date());
    }, 1000);
    
    return () => {
      if (interval) {
        clearInterval(interval);
      }
      if (timeInterval) {
        clearInterval(timeInterval);
      }
    };
  }, [refreshDashboard]);

  // Cleanup on unmount
  useEffect(() => {
    return () => {
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
    };
  }, [refreshInterval]);

  if (!user) {
    return (
      <div className="loading-container">
        <h3>Loading Conductor Dashboard...</h3>
      </div>
    );
  }

  return (
    <div className="conductor-dashboard">
      {/* Fixed Top Header */}
      <div className="dashboard-header">
        <div className="header-left">
          <div className="logo-section">
            <div className="logo-icon">
              <Bus size={20} />
            </div>
            <div className="logo-text">
              <h1>YATRIK ERP</h1>
              <p>Conductor Panel</p>
          </div>
        </div>
      </div>

        <div className="header-center">
          <div className="current-time">
            {currentTime.toLocaleTimeString()}
            </div>
          <div className="duty-status-indicator">
            <div className={`duty-status-dot ${dutyStatus}`}></div>
            <span className="duty-status-text">
                {dutyStatus === 'not_assigned' ? 'No Duty' : 
                 dutyStatus === 'assigned' ? 'Assigned' :
                 dutyStatus === 'active' ? 'Active' : 'Completed'}
              </span>
              </div>
            </div>
            
        <div className="header-right">
          <button className="notification-btn">
            <Bell size={18} />
            {notifications > 0 && (
              <span className="notification-badge">{notifications}</span>
            )}
              </button>
          <button className="logout-btn-header" onClick={handleLogout}>
            <LogOut size={16} />
            Logout
          </button>
        </div>
      </div>

      {/* Sidebar */}
      <div className="conductor-sidebar">
        <div className="sidebar-content">
            {/* Conductor Profile Card */}
            <div className="conductor-profile-card">
              <div className="conductor-profile-header">
                <div className="conductor-info">
                  <h2 className="conductor-name">{user?.name || 'Joel'}</h2>
                  <p className="conductor-id">{user?.id || '68bbca04e8712c602ff588c8'}</p>
                  <div className="conductor-status">
                    <div className={`status-dot ${dutyStatus}`}></div>
                    <span className="status-text">
                      {dutyStatus === 'not_assigned' ? 'No Duty' : 
                       dutyStatus === 'assigned' ? 'Assigned' :
                       dutyStatus === 'active' ? 'Active' : 'Completed'}
                    </span>
            </div>
          </div>
              </div>
            </div>
            
            {/* Vehicle Status Section */}
            <div className="vehicle-status-section">
              <h3 className="section-title">Vehicle Status</h3>
              <div className="status-grid">
                <div className="status-item">
                  <div className="status-icon engine">
                    <CheckCircle size={16} />
            </div>
                  <div className="status-content">
                    <div className="status-label">Engine</div>
                    <div className="status-value">Normal</div>
          </div>
        </div>
                <div className="status-item">
                  <div className="status-icon gps">
                    <MapPin size={16} />
              </div>
                  <div className="status-content">
                    <div className="status-label">GPS</div>
                    <div className="status-value">Active</div>
                      </div>
                </div>
                <div className="status-item">
                  <div className="status-icon fuel">
                    <Fuel size={16} />
                  </div>
                  <div className="status-content">
                    <div className="status-label">Fuel</div>
                    <div className="status-value">85%</div>
                </div>
                </div>
                <div className="status-item">
                  <div className="status-icon speed">
                    <Activity size={16} />
                </div>
                  <div className="status-content">
                    <div className="status-label">Speed</div>
                    <div className="status-value">0 km/h</div>
                </div>
                </div>
              </div>
            </div>

            {/* Duty Controls Section */}
            <div className="duty-controls-section">
              <h3 className="section-title">Duty Controls</h3>
              <div className="control-buttons">
                      <button 
                  className="start-duty-btn"
                  onClick={() => {
                    if (dutyStatus === 'assigned') {
                      setDutyStatus('active');
                    } else if (dutyStatus === 'active') {
                      setDutyStatus('completed');
                    }
                  }}
                  disabled={dutyStatus === 'not_assigned'}
                >
                  <Play size={20} />
                  {dutyStatus === 'assigned' ? 'Start Duty' : 
                   dutyStatus === 'active' ? 'End Duty' : 'No Duty Assigned'}
                      </button>
                      <button 
                  className="refresh-data-btn"
                  onClick={refreshDashboard}
                  disabled={isRefreshing}
                      >
                  <RefreshCw size={16} className={isRefreshing ? 'spinning' : ''} />
                  Refresh Data
                      </button>
              </div>
                  </div>

            {/* ETA & Delay Management Section */}
            <div className="eta-delay-section">
              <h3 className="section-title">ETA & Delay Management</h3>
              <div className="delay-buttons">
                <button className="delay-btn on-time">On Time (+5min)</button>
                <button className="delay-btn slight-delay">Slight Delay (+10min)</button>
                <button className="delay-btn moderate-delay">Moderate Delay (+20min)</button>
                <button className="delay-btn major-delay">Major Delay (+30min)</button>
              </div>
              </div>
            
            {/* Emergency Controls Section */}
            <div className="emergency-section">
              <div className="emergency-header">
                <AlertTriangle className="emergency-icon" />
                <h3 className="emergency-title">Emergency Controls</h3>
              </div>
              <div className="emergency-buttons">
                <button className="emergency-btn">Emergency Stop</button>
                <button className="emergency-btn">Report Incident</button>
                <button className="emergency-btn">Contact Depot</button>
              </div>
            </div>
          </div>
        </div>

      {/* Main Content Area */}
      <div className="main-content">
          <div className="content-header">
            <h1 className="content-title">Current Trip Status</h1>
            <p className="content-subtitle">Distance: 125km • Earnings: ₹1850 • Trips: 3</p>
          </div>

          {/* Navigation Tabs */}
          <div className="nav-tabs">
            <button className="nav-tab active">Dashboard</button>
            <button className="nav-tab">GPS Tracking</button>
            <button className="nav-tab">Fuel Monitor</button>
            <button className="nav-tab">Maintenance</button>
          </div>

          {/* KPI Cards Grid */}
          <div className="kpi-grid">
            <div className="kpi-card">
              <div className="kpi-value">125km</div>
              <div className="kpi-label">Total Distance Today</div>
            </div>
            <div className="kpi-card">
              <div className="kpi-value">₹1850</div>
              <div className="kpi-label">Today's Earnings</div>
            </div>
            <div className="kpi-card">
              <div className="kpi-value">3</div>
              <div className="kpi-label">Completed Trips</div>
              </div>
            <div className="kpi-card">
              <div className="kpi-value fuel">85%</div>
              <div className="kpi-label">Fuel Remaining</div>
            </div>
            </div>
            
          {/* 2-Column Grid Layout */}
          <div className="content-grid">
            {/* Left Column */}
            <div className="content-left">
              {/* Trip Progress Section */}
              <div className="trip-progress-section">
                <div className="progress-header">
                  <MapPin className="progress-icon" />
                  <h3 className="progress-title">Trip Progress</h3>
                </div>
                <div className="trip-details">
                  <div className="trip-info-grid">
                    <div className="trip-info-item">
                      <div className="trip-info-label">Current Route</div>
                      <div className="trip-info-value">Kochi - Alappuzha</div>
                      </div>
                    <div className="trip-info-item">
                      <div className="trip-info-label">Bus Number</div>
                      <div className="trip-info-value">KL-07-CD-5678</div>
                      </div>
                    <div className="trip-info-item">
                      <div className="trip-info-label">Next Stop</div>
                      <div className="trip-info-value">Cherthala</div>
                    </div>
                    <div className="trip-info-item">
                      <div className="trip-info-label">ETA</div>
                      <div className="trip-info-value">15 minutes</div>
                      </div>
                      </div>
                  <div className="progress-section">
                    <div className="progress-bar-container">
                      <div className="progress-bar" style={{ width: '60%' }}></div>
                    </div>
                    <p className="progress-text">60% Complete - 3 stops remaining</p>
                    </div>
                    
                  {/* Route Timeline */}
                  <div className="route-timeline">
                    <div className="timeline-title">Upcoming Stops</div>
                    <div className="timeline-stops">
                      <div className="timeline-stop completed">
                        <div className="stop-indicator"></div>
                        <span className="stop-name">Kochi Central</span>
                        <span className="stop-eta">09:00 AM</span>
                      </div>
                      <div className="timeline-stop completed">
                        <div className="stop-indicator"></div>
                        <span className="stop-name">Edappally</span>
                        <span className="stop-eta">09:15 AM</span>
                      </div>
                      <div className="timeline-stop current">
                        <div className="stop-indicator"></div>
                        <span className="stop-name">Cherthala</span>
                        <span className="stop-eta">09:30 AM</span>
                      </div>
                      <div className="timeline-stop pending">
                        <div className="stop-indicator"></div>
                        <span className="stop-name">Alappuzha</span>
                        <span className="stop-eta">09:45 AM</span>
                      </div>
                    </div>
                  </div>
                </div>
            </div>
            
              {/* Route Information */}
              <div className="dashboard-card">
                <div className="card-header">
                  <h3 className="card-title">Route Information</h3>
                </div>
                <div className="card-content">
                  <div className="route-summary">
                    <div className="route-info-item">
                      <div className="route-info-label">Start Point</div>
                      <div className="route-info-value">Kochi Central</div>
            </div>
                    <div className="route-info-item">
                      <div className="route-info-label">End Point</div>
                      <div className="route-info-value">Alappuzha</div>
                      </div>
                    <div className="route-info-item">
                      <div className="route-info-label">Total Distance</div>
                      <div className="route-info-value highlight">125 km</div>
                        </div>
                    <div className="route-info-item">
                      <div className="route-info-label">Expected Arrival</div>
                      <div className="route-info-value">09:45 AM</div>
                    </div>
                    <div className="route-info-item">
                      <div className="route-info-label">Total Fare</div>
                      <div className="route-info-value highlight">₹45</div>
                    </div>
                    <div className="route-info-item">
                      <div className="route-info-label">Stops</div>
                      <div className="route-info-value">4 stops</div>
                </div>
                </div>
                </div>
              </div>
            </div>
            
            {/* Right Column */}
            <div className="content-right">
              {/* Recent Passengers */}
              <div className="dashboard-card">
                <div className="card-header">
                  <h3 className="card-title">Recent Passengers</h3>
                </div>
            <div className="card-content">
                  <table className="passengers-table">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Seat</th>
                        <th>Route</th>
                        <th>Fare</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td className="passenger-name">Rajesh Kumar</td>
                        <td className="passenger-seat">A12</td>
                        <td className="passenger-route">Kochi → Alappuzha</td>
                        <td className="passenger-fare">₹45</td>
                      </tr>
                      <tr>
                        <td className="passenger-name">Priya Menon</td>
                        <td className="passenger-seat">B08</td>
                        <td className="passenger-route">Cherthala → Alappuzha</td>
                        <td className="passenger-fare">₹25</td>
                      </tr>
                      <tr>
                        <td className="passenger-name">Suresh Nair</td>
                        <td className="passenger-seat">C15</td>
                        <td className="passenger-route">Kochi → Cherthala</td>
                        <td className="passenger-fare">₹35</td>
                      </tr>
                      <tr>
                        <td className="passenger-name">Anita Raj</td>
                        <td className="passenger-seat">A05</td>
                        <td className="passenger-route">Edappally → Alappuzha</td>
                        <td className="passenger-fare">₹40</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              
              {/* Maintenance Alerts */}
              <div className="dashboard-card">
                <div className="card-header">
                  <h3 className="card-title">Maintenance Alerts</h3>
                </div>
                <div className="card-content">
                  <div className="maintenance-alerts">
                    <div className="alert-item warning">
                      <div className="alert-icon warning">
                        <Wrench size={12} />
                      </div>
                      <div className="alert-content">
                        <div className="alert-title">Oil Change Due</div>
                        <div className="alert-message">Next service in 500 km</div>
                      </div>
                      <div className="alert-time">2h ago</div>
                    </div>
                    <div className="alert-item info">
                      <div className="alert-icon info">
                        <CheckCircle size={12} />
                      </div>
                      <div className="alert-content">
                        <div className="alert-title">Tire Pressure OK</div>
                        <div className="alert-message">All tires within normal range</div>
                      </div>
                      <div className="alert-time">1h ago</div>
                    </div>
                    <div className="alert-item critical">
                      <div className="alert-icon critical">
                        <AlertCircle size={12} />
                      </div>
                      <div className="alert-content">
                        <div className="alert-title">Engine Check</div>
                        <div className="alert-message">Minor vibration detected</div>
                      </div>
                      <div className="alert-time">30m ago</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ConductorDashboard;